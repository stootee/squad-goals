<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Stats Input</title>
<style>
body { font-family: sans-serif; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
.container { background-color: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
h1 { color: #333; margin-top: 0; }
.form-group { margin-bottom: 1rem; text-align: left; }
label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
input[type="number"], input[type="date"] { width: 100%; padding: 0.75rem; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
button { width: 100%; padding: 0.75rem; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; }
button:hover { background-color: #0056b3; }
.message { margin-top: 1rem; padding: 1em; border-radius: 4px; font-weight: bold; display: none; }
.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.nav-links { margin-top: 1em; }
.nav-links a { margin: 0 0.5em; color: #007bff; text-decoration: none; }
</style>
</head>
<body>
<div class="container">
    <h1>Update Daily Stats</h1>
    <div id="message-container" class="message"></div>
    <form id="daily-stats-form">
        <div class="form-group">
            <label for="date-input">Date:</label>
            <input type="date" id="date-input" name="date" required>
        </div>
        <div class="form-group">
            <label for="steps">Steps:</label>
            <input type="number" id="steps" name="steps">
        </div>
        <div class="form-group">
            <label for="calories_in">Calories In (kcal):</label>
            <input type="number" id="calories_in" name="calories_in">
        </div>
        <div class="form-group">
            <label for="water_in">Water In (ml):</label>
            <input type="number" id="water_in" name="water_in">
        </div>
        <div class="form-group">
            <label for="sleep">Sleep (hours):</label>
            <input type="number" id="sleep" name="sleep" step="0.1">
        </div>
        <div class="form-group">
            <label for="exercise">Exercise (minutes):</label>
            <input type="number" id="exercise" name="exercise">
        </div>
        <div class="form-group">
            <label for="protein">Protein (g):</label>
            <input type="number" id="protein" name="protein">
        </div>
        <button type="submit">Save Stats</button>
    </form>
    <div class="nav-links">
        <a href="weekly_stats.html">View Weekly Stats</a> |
        <a href="profile.html">User Profile</a> |
        <a href="#" onclick="logout()">Log Out</a>
    </div>
</div>

<script src="config.js"></script>
<script src="auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('date-input');
    const form = document.getElementById('daily-stats-form');
    const messageDiv = document.getElementById('message-container');
    const apiURL = window.APP_CONFIG.API_URL;

    // Set date to today initially
    if (dateInput) dateInput.value = new Date().toISOString().slice(0, 10);

    // Function to populate or clear form
    async function loadStatsForDate(dateStr) {
        try {
            const response = await fetch(`${apiURL}/daily_stats?date=${dateStr}`, {
                method: 'GET',
                credentials: 'include',
            });
            if (!response.ok) throw new Error('No data for this date');

            const stats = await response.json();

            // Populate fields if data exists
            ['steps', 'calories_in', 'water_in', 'sleep', 'exercise', 'protein'].forEach(field => {
                form[field].value = stats[field] ?? '';
            });
        } catch (err) {
            // Clear fields if no data or error
            ['steps', 'calories_in', 'water_in', 'sleep', 'exercise', 'protein'].forEach(field => {
                form[field].value = '';
            });
        }
    }

    // Load stats initially
    if (dateInput.value) loadStatsForDate(dateInput.value);

    // Load stats whenever date changes
    dateInput.addEventListener('change', () => {
        loadStatsForDate(dateInput.value);
    });

    // Submit handler (POST existing code)
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());

        // Remove empty fields
        Object.keys(data).forEach(k => { if (data[k] === '') delete data[k]; });

        try {
            const response = await fetch(`${apiURL}/daily_stats`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                messageDiv.textContent = result.message || 'Stats saved successfully!';
                messageDiv.className = 'message success';
                // Redirect to weekly stats after submission
                window.location.href = 'weekly_stats.html';
            } else {
                messageDiv.textContent = result.message || 'Failed to save stats.';
                messageDiv.className = 'message error';
            }
        } catch (err) {
            console.error('Error submitting daily stats:', err);
            messageDiv.textContent = 'Unable to reach server. Please try again later.';
            messageDiv.className = 'message error';
        } finally {
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }
    });
});
</script>
</body>
</html>
